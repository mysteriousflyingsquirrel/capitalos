{
  "version": "1.0",
  "id": "exchanges-hyperliquid",
  "title": "Hyperliquid Exchange Integration",
  "source": "docs/requirements.md Section 4 Perpetuals, Section 9 Perpetuals, Exchanges – Hyperliquid",
  "specRef": "docs/specs/exchanges-hyperliquid.spec.md",
  "scope": {
    "inScope": [
      "Credentials (wallet address) and storage",
      "REST vs WebSocket responsibilities",
      "PerpetualsData normalization (positions, open orders, portfolio PnL)",
      "Positions table Price column (markPx from asset context)",
      "Performance windows (24h/7d/30d/90d)",
      "Error handling and missing-credential behavior",
      "Crash-Risk Indicator (3-Pillar system)",
      "Profit Reminder System (milestone-based)"
    ],
    "outOfScope": [
      "Kraken / MEXC / Aster",
      "Bot alerts or automation",
      "SL or order detection",
      "Tooltips for risk indicator"
    ]
  },
  "acceptanceCriteria": [
    "When mark prices are available, Positions 'Price' column MUST display $<formatted markPx>.",
    "If WS disconnected and REST positions exist, positions table MUST still render from REST snapshot.",
    "Performance PnL boxes MUST render 24h/7d/30d/90d values or 'N/A' if null.",
    "If wallet address is not configured, Hyperliquid Perpetuals item MUST be absent or contain empty arrays (no crash).",
    "Risk Indicator: Assets with dayNtlVlm < $25M OR openInterest < $10M show UNSUPPORTED state.",
    "Risk Indicator: RED only fires when ALL 3 pillars agree (crowding + structure broken + liquidity fragile).",
    "Risk Indicator: State cannot downgrade faster than cooldown period (30min RED, 15min ORANGE).",
    "Profit Reminders: Fire at +5%, +10% milestones; only once per position.",
    "Profit Reminders: Replaced with risk warning when RED active.",
    "Missing data displays '–' and rendering never crashes."
  ],
  "data": {
    "credentialsPath": "users/{uid}/settings/user -> apiKeys.hyperliquidWalletAddress",
    "restEndpoint": "POST /api/perpetuals/hyperliquid",
    "wsEndpoint": "wss://api.hyperliquid.xyz/ws",
    "wsSubscription": "clearinghouseState, user: walletAddress",
    "markPriceSource": "useHyperliquidAssetCtx (asset context stream)",
    "crashRiskIndicator": {
      "dataSources": {
        "primary": "metaAndAssetCtxs (markPx, oraclePx, funding, openInterest, premium, dayNtlVlm, impactPxs)",
        "fallback": "l2Book (bestBid, bestAsk, depth within ±0.2%)",
        "optional": "recentTrades (price impulse confirmation)"
      },
      "stabilityGate": {
        "dayNtlVlm": "> $25,000,000",
        "openInterest": "> $10,000,000"
      },
      "refreshIntervals": {
        "metaAndAssetCtxs": "15 seconds",
        "l2Book": "30 seconds (fallback only)",
        "historicalLookback": "5 minutes (cached)"
      }
    }
  },
  "logic": {
    "priceColumn": "MUST display markPx from asset context; if missing display dash. MUST NOT display entry/mid/oracle/liquidation price.",
    "performanceWindows": "24h/7d/30d from deltaFromBucket (pnlHistory or accountValueHistory); 90d from pnl90dUsd (closest point to 90 days ago).",
    "missingWallet": "REST fetch MUST return null (hyperliquidService.fetchHyperliquidPerpetualsData).",
    "crashRiskIndicator": {
      "pillar1_crowding": {
        "metrics": ["openInterest", "funding"],
        "formula": "OI_z = zscore(openInterest, 7d); F_z = zscore(funding, 7d)",
        "condition": "OI_z >= 1.5 AND |F_z| >= 1.5 AND confirmed for 2 consecutive 15-min windows",
        "direction": "F_z > 0 = Long crowding; F_z < 0 = Short crowding"
      },
      "pillar2_structure": {
        "metrics": ["markPx returns"],
        "longCrowded": {
          "intact": "15m return > 0 AND 1h return > 0",
          "weakening": "15m return <= 0 OR 1h return ≈ 0",
          "broken": "15m return < 0 AND 1h return < 0"
        },
        "shortCrowded": {
          "intact": "15m return < 0 AND 1h return < 0",
          "weakening": "15m return >= 0 OR 1h return ≈ 0",
          "broken": "15m return > 0 AND 1h return > 0"
        },
        "zeroThreshold": "|return| < 0.001 (0.1%)"
      },
      "pillar3_liquidity": {
        "preferred": "impactPxs from metaAndAssetCtxs",
        "fallback": "l2Book spread + depth",
        "fragileCondition": "impact_cost_z >= 1.5 OR spread_z >= 1.5 OR depth_z <= -1.5",
        "confirmation": "2 consecutive checks"
      },
      "stateLogic": {
        "GREEN": "crowding = FALSE OR (crowding = TRUE AND structure = INTACT)",
        "ORANGE": "crowding = TRUE AND structure = WEAKENING AND liquidity != FRAGILE",
        "RED": "crowding = TRUE AND structure = BROKEN AND liquidity = FRAGILE",
        "UNSUPPORTED": "stability gate failed"
      },
      "cooldowns": {
        "RED": "30 minutes minimum hold",
        "ORANGE": "15 minutes minimum hold"
      }
    },
    "profitReminderSystem": {
      "milestones": [
        { "threshold": "+5%", "message": "You're up ~5%. Consider moving your stop to break-even." },
        { "threshold": "+10%", "message": "You're up ~10%. Consider trailing your stop to lock in profits." },
        { "threshold": "+15%", "message": "You're up ~15%. Strong gains—consider partial take-profit.", "optional": true },
        { "threshold": "+20%", "message": "You're up ~20%. Excellent trade. Protect these gains.", "optional": true }
      ],
      "fireBehavior": "Once per position per milestone",
      "redOverride": "You're in profit, but risk is high. Protect gains now.",
      "stateTracking": "firedMilestones: Record<positionId, Set<milestone>>; reset on position close"
    }
  },
  "ui": {
    "wsStatusValues": ["disconnected", "connecting", "subscribed", "error"],
    "emptyTables": "No positions / No open orders",
    "crashRiskIndicator": {
      "frameTitle": "Risk Indicator",
      "location": "Top of Hyperliquid page, above Performance frame",
      "content": "One line per open position with colored dot + message",
      "sorting": "RED first, then ORANGE, then GREEN, then UNSUPPORTED",
      "noTooltips": true,
      "messages": {
        "GREEN": "Market is stable. Trade as planned.",
        "ORANGE": "Risk is rising. Consider reducing size or tightening your stop.",
        "RED": "High crash risk. Protect capital or exit.",
        "UNSUPPORTED": "Market too unstable for reliable risk signals."
      },
      "dotColors": {
        "GREEN": "#2ECC71",
        "ORANGE": "#F39C12",
        "RED": "#E74C3C",
        "UNSUPPORTED": "#A0AEC0"
      }
    },
    "profitReminders": {
      "display": "Secondary line below indicator OR toast/notification",
      "mustNotObscure": "indicator message"
    },
    "missingDataRule": "Display '–' (dash); never blank, never 0. Do not crash on null/undefined."
  }
}
